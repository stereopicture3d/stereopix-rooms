<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<link rel="icon" href="data:,">
		<link rel="stylesheet" href="/style.css"/>
		<title>Stereopix ROOMS</title>
	</head>
	<body class="centered">
		<h1 style="display: none">Stereopix ROOMS</h1>
		<p class="subtitle"><a href="/">ROOMS</a> uses the viewer of <a href="https://stereopix.net/">Stereopix</a> to create interactive rooms.</p>
		<script>
let socket = false;
function connect(room) {
	socket = new WebSocket("ws" + (document.location.protocol == "https:" ? "s" : "") + "://" + document.location.host + "/ws");
	socket.onopen = function(e) {
		console.log("[open] Connection established");
		document.getElementById("room_name").innerText = room;
		document.getElementById("connected").innerText = "Yes";
		document.getElementById("connected_clients").innerText = "0";
		document.body.classList.remove('error');
		document.getElementById('presenter_block').style.display = 'block';
		socket.send(JSON.stringify({ 'type': 'hello', 'action': 'present', 'room': room }));
	};

	socket.onmessage = function(event) {
		console.log(`[message] Data received from server: ${event.data}`);
		j = JSON.parse(event.data);

		if (j.type == 'room_already_opened') {
			document.getElementById('error_log').innerText = "This room is already controlled."

		} else if (j.type == 'room_stolen_kick') {
			document.getElementById('error_log').innerText = "This room was stolen."

		} else if (j.type == 'room_stolen') {
			document.getElementById("json_code").value = j.json;
			document.getElementById("page").value = j.page;

		} else if (j.type == 'nb_connected') {
			document.getElementById("connected_clients").innerText = j.nb;
		}
	};

	socket.onclose = function(event) {
		if (event.wasClean) {
			console.log(`[close] Connection closed cleanly, code=${event.code} reason=${event.reason}`);
		} else {
			console.log('[close] Connection died');
		}
		document.getElementById("connected").innerText = "No";
		document.getElementById("connected_clients").innerText = "0";
		document.body.classList.add('error');
		document.getElementById('presenter_block').style.display = 'none';
	};

	socket.onerror = function(error) {
		console.log(`[error] ${error.message}`);
	};
}

window.addEventListener("DOMContentLoaded", (event) => {
	room = false;
	document.location.search.substring(1).split('&').forEach(kv => {
		const [key, value] = kv.split('=');
		if (key == "room")
			room = value ? decodeURIComponent(value.replace(/\+/g, ' ')) : false;
	});
	document.getElementById("allow_stealing").checked = false;
	document.getElementById("allow_stealing").addEventListener("change", e => {
		if (socket)
			socket.send(JSON.stringify({ 'type': 'allow_stealing', 'value': e.target.checked }));
	});
	document.getElementById("json_form").addEventListener("submit", e => {
		e.preventDefault();
		let j = null;
		try {
			JSON.parse(document.getElementById("json_code").value);
			j = document.getElementById("json_code").value;
		} catch(e) {
			alert("Invalid JSON syntax");
			console.warn(e);
		}
		if (socket && j)
			socket.send(JSON.stringify({ 'type': 'open_room', 'json': j }));
	});
	document.getElementById("page_form").addEventListener("submit", e => {
		e.preventDefault();
		if (socket)
			socket.send(JSON.stringify({ 'type': 'change_page', 'page': document.getElementById("page").value }));
	});
	if (room)
		connect(room);
});
window.addEventListener("beforeunload", e => {
	const msg = "By closing this page, you will close the room";
	e.returnValue = msg;
	return msg;
});
		</script>
		<p>Room name: <span id="room_name">Unknown</span></p>
		<p>Connected: <span id="connected">No</span></p>
		<p>Connected clents: <span id="connected_clients">0</span></p>
		<p id="error_log"></p>
		<div id="presenter_block" style="display:none">
		<p><label><input type="checkbox" id="allow_stealing" />Allow stealing of the room</label></p>
		<h2>JSON</h2>
		<form id="json_form">
			<textarea id="json_code" style="width: 90%; min-height: 200px"></textarea>
			<br />
			<input type="submit" />
		</form>

		<h2>Page number</h2>
		<form id="page_form">
			<input type="number" value="0" id="page" style="width: 90%;" />
			<br />
			<input type="submit" />
		</form>
		</div>
	</body>
</html>
